<story-context id="bmm/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.9</storyId>
    <title>Deployment & Production Readiness</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/scrum/stories/1-9-deployment-production-readiness.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps engineer</asA>
    <iWant>to deploy the foundation services to production</iWant>
    <soThat>authentication and basic infrastructure are live and tested</soThat>
    <tasks>
      - Task 1: Create GitHub Actions Workflow File (AC: 1)
      - Task 2: Configure AWS ECR Repository (AC: 1)
      - Task 3: Create ECS Task Definition (AC: 1, 7)
      - Task 4: Configure ECS Service with Blue-Green Deployment (AC: 1)
      - Task 5: Frontend Build and S3 Deployment (AC: 2)
      - Task 6: Configure CloudFront Distribution (AC: 2, 9)
      - Task 7: Configure AWS Secrets Manager (AC: 7)
      - Task 8: Database Migration Automation (AC: 8)
      - Task 9: CloudWatch Dashboards Setup (AC: 5)
      - Task 10: CloudWatch Alarms Configuration (AC: 6)
      - Task 11: Health Check Endpoint Enhancement (AC: 3)
      - Task 12: Smoke Tests Implementation (AC: 4)
      - Task 13: OAuth Production Configuration (AC: 4, 9)
      - Task 14: SSL/TLS Certificate Configuration (AC: 9)
      - Task 15: Security Headers Configuration (AC: 9)
      - Task 16: Create Deployment Runbook (AC: 10)
      - Task 17: Integration Testing - End-to-End Deployment (AC: All)
      - Task 18: Write Deployment Tests (AC: All)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>GitHub Actions CI/CD Pipeline Configuration</title>
      <description>Pipeline executes tests, builds Docker images, pushes to ECR, deploys to ECS with blue-green strategy, runs smoke tests, and rolls back on failure</description>
    </criterion>
    <criterion id="AC2">
      <title>Frontend Build and Deployment</title>
      <description>Frontend builds with npm, uploads to S3, serves via CloudFront with cache invalidation</description>
    </criterion>
    <criterion id="AC3">
      <title>Health Check Endpoints Validation</title>
      <description>GET /health and /ready endpoints return 200 with version/timestamp, smoke tests validate deployment</description>
    </criterion>
    <criterion id="AC4">
      <title>Authentication Smoke Tests</title>
      <description>Google and Clever OAuth flows work in production with correct callback URLs and session cookies</description>
    </criterion>
    <criterion id="AC5">
      <title>CloudWatch Monitoring Dashboards</title>
      <description>Dashboards show request count, error rate, response time (p50/p95/p99), database connections, ECS metrics</description>
    </criterion>
    <criterion id="AC6">
      <title>CloudWatch Alarms Configuration</title>
      <description>Alarms for error rate >5%, response time >10s, database connections >80%, unhealthy ECS tasks with SNS notifications</description>
    </criterion>
    <criterion id="AC7">
      <title>Environment Variables and Secrets Management</title>
      <description>Secrets stored in AWS Secrets Manager (DATABASE_URL, OAuth keys, SESSION_SECRET_KEY) with 90-day rotation</description>
    </criterion>
    <criterion id="AC8">
      <title>Database Migration Execution</title>
      <description>Alembic migrations run automatically before deployment, idempotent, fail deployment if errors</description>
    </criterion>
    <criterion id="AC9">
      <title>Production URL and SSL/TLS Configuration</title>
      <description>HTTPS-only access with valid SSL certificate, auto-renewal, security headers (HSTS, X-Frame-Options, CSP)</description>
    </criterion>
    <criterion id="AC10">
      <title>Deployment Runbook Documentation</title>
      <description>Runbook at /docs/deployment-runbook.md with deployment steps, rollback, troubleshooting, tested procedure</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-1-foundation-authentication.md</path>
        <title>Epic 1: Foundation & Authentication</title>
        <section>Story 1.9: Deployment & Production Readiness</section>
        <snippet>Final story in Epic 1. Deploy foundation services to production, configure CI/CD pipeline with GitHub Actions, AWS ECS Fargate, S3/CloudFront for frontend, CloudWatch monitoring, and production authentication flows.</snippet>
      </doc>
      <doc>
        <path>docs/scrum/stories/1-1-project-infrastructure-setup.md</path>
        <title>Story 1.1: Project Infrastructure Setup</title>
        <section>Infrastructure Foundation</section>
        <snippet>Established AWS infrastructure foundation: VPC, ECS Fargate cluster, RDS PostgreSQL, S3 buckets, CloudFront, ALB, CloudWatch, Secrets Manager. Infrastructure as code using Terraform/CloudFormation.</snippet>
      </doc>
      <doc>
        <path>docs/scrum/stories/1-2-database-schema-creation.md</path>
        <title>Story 1.2: Database Schema Creation</title>
        <section>Database Migrations</section>
        <snippet>Alembic configured for database migrations. Migration scripts create users, sessions, conversations, messages tables with proper indexes. Rollback procedures documented.</snippet>
      </doc>
      <doc>
        <path>docs/scrum/stories/1-3-backend-api-service-foundation.md</path>
        <title>Story 1.3: Backend API Service Foundation</title>
        <section>Health Endpoints</section>
        <snippet>Health check endpoints implemented: GET /health (service status), GET /ready (database connectivity). Docker container configured with structured logging to CloudWatch.</snippet>
      </doc>
      <doc>
        <path>docs/scrum/stories/1-4-google-oidc-authentication.md</path>
        <title>Story 1.4: Google OIDC Authentication</title>
        <section>OAuth Configuration</section>
        <snippet>Google OAuth implemented with authlib. Client ID and Secret in AWS Secrets Manager. OAuth redirect URIs configured. Production redirect URIs need updating in this story.</snippet>
      </doc>
      <doc>
        <path>docs/scrum/stories/1-5-clever-sso-authentication.md</path>
        <title>Story 1.5: Clever SSO Authentication</title>
        <section>Clever SSO</section>
        <snippet>Clever SSO implemented. Client credentials in Secrets Manager. Production callback URLs need configuration in this story.</snippet>
      </doc>
      <doc>
        <path>docs/scrum/stories/1-8-user-profile-role-management.md</path>
        <title>Story 1.8: User Profile & Role Management</title>
        <section>Testing Infrastructure</section>
        <snippet>47 tests passing (pytest). Docker-based development and testing. Test suite must pass in CI/CD pipeline before deployment.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>api-service/Dockerfile</path>
        <kind>dockerfile</kind>
        <symbol>Multi-stage Dockerfile</symbol>
        <lines>1-31</lines>
        <reason>Production Docker build configuration. Contains HEALTHCHECK for /health endpoint. Needs optimization for production (multi-stage build for smaller image size).</reason>
      </file>
      <file>
        <path>api-service/app/routers/health.py</path>
        <kind>router</kind>
        <symbol>health_check, readiness_check</symbol>
        <lines>14-52</lines>
        <reason>Existing health endpoints. AC3 requires enhancement with version and timestamp. Currently returns basic status and database connectivity.</reason>
      </file>
      <file>
        <path>api-service/app/config.py</path>
        <kind>config</kind>
        <symbol>Settings class</symbol>
        <lines>all</lines>
        <reason>Application configuration. Needs environment-specific settings (production vs development). Should load secrets from AWS Secrets Manager in production.</reason>
      </file>
      <file>
        <path>api-service/app/main.py</path>
        <kind>application</kind>
        <symbol>FastAPI app initialization</symbol>
        <lines>all</lines>
        <reason>Main application entry point. CORS middleware, router registration, startup events. Used by uvicorn in production.</reason>
      </file>
      <file>
        <path>api-service/app/services/database.py</path>
        <kind>service</kind>
        <symbol>SessionLocal, get_db</symbol>
        <lines>all</lines>
        <reason>Database connection setup. DATABASE_URL should come from AWS Secrets Manager in production (AC7).</reason>
      </file>
      <file>
        <path>api-service/tests/conftest.py</path>
        <kind>test-config</kind>
        <symbol>pytest fixtures</symbol>
        <lines>all</lines>
        <reason>Test configuration and fixtures. Tests run in CI/CD pipeline (AC1). All 47 tests must pass before deployment.</reason>
      </file>
      <file>
        <path>frontend/vite.config.ts</path>
        <kind>build-config</kind>
        <symbol>Vite configuration</symbol>
        <lines>all</lines>
        <reason>Frontend build configuration. npm run build creates static files for S3 deployment (AC2).</reason>
      </file>
      <file>
        <path>frontend/package.json</path>
        <kind>manifest</kind>
        <symbol>build script</symbol>
        <lines>8</lines>
        <reason>Build command: "tsc -b && vite build". Used in GitHub Actions to create production frontend bundle.</reason>
      </file>
      <file>
        <path>api-service/app/schemas/health.py</path>
        <kind>schema</kind>
        <symbol>HealthResponse</symbol>
        <lines>all</lines>
        <reason>Health check response schema. Needs enhancement to include version and timestamp fields (AC3).</reason>
      </file>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version="0.109.0" />
        <package name="uvicorn" version="0.27.0" />
        <package name="alembic" version="1.13.1" />
        <package name="SQLAlchemy" version="2.0.25" />
        <package name="psycopg2-binary" version="2.9.9" />
        <package name="boto3" version="1.34.34" reason="AWS SDK - needed for Secrets Manager access" />
        <package name="pydantic" version="2.5.3" />
        <package name="authlib" version="1.3.0" reason="OAuth authentication" />
        <package name="pytest" version="7.4.4" reason="Test framework for CI/CD pipeline" />
        <package name="pytest-cov" version="4.1.0" reason="Test coverage reporting" />
        <package name="apscheduler" version="3.10.4" reason="Background job scheduling" />
      </python>
      <nodejs>
        <package name="vite" version="^7.2.2" reason="Frontend build tool" />
        <package name="typescript" version="~5.9.3" />
        <package name="react" version="^19.2.0" />
        <package name="react-dom" version="^19.2.0" />
        <package name="axios" version="^1.13.2" />
        <package name="@tanstack/react-query" version="^5.90.8" />
        <package name="tailwindcss" version="^4.1.17" />
      </nodejs>
      <aws>
        <service name="ECR" purpose="Docker image registry" />
        <service name="ECS Fargate" purpose="Container orchestration - backend deployment" />
        <service name="S3" purpose="Frontend static file hosting" />
        <service name="CloudFront" purpose="CDN for frontend distribution" />
        <service name="Secrets Manager" purpose="Secure credential storage" />
        <service name="CloudWatch" purpose="Logging, monitoring, dashboards, alarms" />
        <service name="ALB" purpose="Application Load Balancer for backend API" />
        <service name="ACM" purpose="SSL/TLS certificate management" />
        <service name="CodeDeploy" purpose="Blue-green deployment orchestration" />
        <service name="SNS" purpose="Alarm notifications" />
      </aws>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="deployment">
      All 47 backend tests must pass before deployment proceeds. Test failures block CI/CD pipeline.
    </constraint>
    <constraint type="deployment">
      Database migrations must run successfully before application deployment. Migration failures prevent deployment.
    </constraint>
    <constraint type="deployment">
      Smoke tests must pass after deployment. Failed smoke tests trigger automatic rollback to previous version.
    </constraint>
    <constraint type="security">
      No secrets or credentials in code or git. All sensitive config must be in AWS Secrets Manager.
    </constraint>
    <constraint type="security">
      Production must use HTTPS only. HTTP requests redirect to HTTPS. Valid SSL certificate required.
    </constraint>
    <constraint type="security">
      Security headers required: HSTS, X-Frame-Options: DENY, Content-Security-Policy, X-Content-Type-Options: nosniff
    </constraint>
    <constraint type="infrastructure">
      Blue-green deployment strategy required for zero-downtime deployments. CodeDeploy manages traffic shifting.
    </constraint>
    <constraint type="infrastructure">
      Docker images must be tagged with git SHA and "latest". Enables version tracking and rollback.
    </constraint>
    <constraint type="monitoring">
      CloudWatch alarms must be configured for: error rate, response time, database connections, ECS health. SNS notifications required.
    </constraint>
    <constraint type="oauth">
      Production OAuth redirect URIs must be registered with Google and Clever. URLs must use production domain with HTTPS.
    </constraint>
    <constraint type="documentation">
      Deployment runbook must be created and tested. Team must be able to follow runbook to deploy successfully.
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /health</name>
      <kind>REST endpoint</kind>
      <signature>GET /health → {status: string, service: string, version: string}</signature>
      <path>api-service/app/routers/health.py:14-25</path>
      <notes>Current implementation returns basic status. AC3 requires version and timestamp addition.</notes>
    </interface>
    <interface>
      <name>GET /ready</name>
      <kind>REST endpoint</kind>
      <signature>GET /ready → {status: string, database: string} | 503 on failure</signature>
      <path>api-service/app/routers/health.py:28-52</path>
      <notes>Readiness probe for Kubernetes/ECS health checks. Tests database connectivity with SELECT 1.</notes>
    </interface>
    <interface>
      <name>HealthResponse Schema</name>
      <kind>Pydantic schema</kind>
      <signature>class HealthResponse(BaseModel): status: str, service: str, version: str, database: str, timestamp: datetime</signature>
      <path>api-service/app/schemas/health.py</path>
      <notes>Needs enhancement to include timestamp field for AC3.</notes>
    </interface>
    <interface>
      <name>Alembic Migrations</name>
      <kind>Database migration</kind>
      <signature>alembic upgrade head</signature>
      <path>api-service/alembic/</path>
      <notes>Automated migration execution in deployment pipeline. Idempotent migrations required.</notes>
    </interface>
    <interface>
      <name>GitHub Actions Workflow</name>
      <kind>CI/CD pipeline</kind>
      <signature>.github/workflows/deploy-production.yml</signature>
      <path>.github/workflows/deploy-production.yml (to be created)</path>
      <notes>Triggers on push to main. Jobs: test → build → push → migrate → deploy → smoke-test → rollback-on-failure</notes>
    </interface>
    <interface>
      <name>AWS Secrets Manager</name>
      <kind>Secrets storage</kind>
      <signature>boto3.client('secretsmanager').get_secret_value(SecretId='plccoach/production/...')</signature>
      <path>api-service/app/config.py</path>
      <notes>Secrets: database, google-oauth, clever-sso, session. Application retrieves at startup.</notes>
    </interface>
    <interface>
      <name>CloudWatch Metrics</name>
      <kind>Monitoring API</kind>
      <signature>AWS CloudWatch Metrics: ALB RequestCount, 4XXCount, 5XXCount, TargetResponseTime, RDS DatabaseConnections, ECS CPUUtilization</signature>
      <path>AWS CloudWatch Console / API</path>
      <notes>Metrics for dashboards and alarms. Collected automatically by AWS services.</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing infrastructure established in Story 1.8. All backend tests use pytest with fixtures from conftest.py. Tests run in Docker containers. Test database uses SQLite or PostgreSQL. Coverage reporting with pytest-cov. CI/CD pipeline requires all tests to pass (47 tests currently). Smoke tests validate production deployment health and authentication flows.
    </standards>
    <locations>
      - api-service/tests/test_*.py (unit and integration tests)
      - api-service/tests/conftest.py (shared fixtures)
      - scripts/smoke-tests.sh (post-deployment validation)
      - tests/deployment/test_smoke.py (deployment verification tests)
    </locations>
    <ideas>
      <test ac="AC1">
        - Test GitHub Actions workflow syntax validation
        - Mock ECR push and verify image tags (git SHA, latest)
        - Verify pipeline fails if tests fail
        - Verify pipeline fails if migrations fail
        - Verify rollback triggers on smoke test failure
      </test>
      <test ac="AC2">
        - Test frontend build produces dist/ folder
        - Verify S3 upload includes all build artifacts
        - Test CloudFront invalidation API call
        - Verify frontend accessible via CloudFront URL
      </test>
      <test ac="AC3">
        - Test GET /health returns 200 with version and timestamp
        - Test GET /ready returns 200 when database is accessible
        - Test GET /ready returns 503 when database is down
        - Verify health check response schema matches Pydantic model
      </test>
      <test ac="AC4">
        - Smoke test: curl GET /auth/google/login returns 302 redirect
        - Smoke test: curl GET /auth/clever/login returns 302 redirect
        - Verify OAuth callback URLs use production domain
        - Test session cookie set with secure and httpOnly flags
        - Integration test: Complete OAuth flow end-to-end
      </test>
      <test ac="AC5">
        - Verify CloudWatch dashboard exists (API call or console check)
        - Verify dashboard widgets configured for required metrics
        - Test metric data is populating (wait 5 minutes, check values)
      </test>
      <test ac="AC6">
        - Verify 4 CloudWatch alarms created (error rate, response time, database, ECS)
        - Test alarm threshold configuration
        - Trigger alarm condition (stop ECS task) and verify SNS notification sent
        - Verify alarm state transitions to ALARM
      </test>
      <test ac="AC7">
        - Verify secrets exist in AWS Secrets Manager (4 secrets)
        - Test ECS task can retrieve secrets at runtime
        - Verify DATABASE_URL loaded correctly (database connection works)
        - Test 90-day rotation policy configured
      </test>
      <test ac="AC8">
        - Test migration script runs idempotently (run twice, no errors)
        - Verify migrations run before deployment in CI/CD
        - Test migration failure blocks deployment
        - Verify rollback procedure (alembic downgrade -1)
      </test>
      <test ac="AC9">
        - Test production URL accessible via HTTPS
        - Test HTTP redirects to HTTPS
        - Verify SSL certificate is valid (not expired, trusted CA)
        - Test security headers present in response (HSTS, X-Frame-Options, CSP)
        - Use https://securityheaders.com to validate
      </test>
      <test ac="AC10">
        - Verify deployment-runbook.md exists at /docs/
        - Review runbook completeness (all required sections present)
        - Perform test deployment following runbook steps
        - Verify runbook accuracy (no missing or incorrect steps)
      </test>
    </ideas>
  </tests>
</story-context>
